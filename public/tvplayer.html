<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <title>S0LACE • TV Player</title>

    <link rel="shortcut icon" content="favicon.ico" />
    <link rel="stylesheet" href="index.css" />

    <!-- BareMux + Epoxy for Scramjet backend -->
    <script src="baremux/index.js"></script>
    <script src="epoxy/index.js"></script>

    <!-- Service worker + global stuff -->
    <script src="register-sw.js" defer></script>
    <script src="global-hub.js" defer></script>

    <!-- TV-only layout styles (big frame left, season list right) -->
    <style>
      .tv-player-main {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .tv-layout {
        display: flex;
        gap: 14px;
        align-items: stretch;
        flex: 1;
        min-height: 0;
      }

      /* left side = big player (frame styles mostly come from index.css) */
      .tv-frame-wrap {
        flex: 1;
        min-height: calc(100vh - 150px);
        display: flex;
        flex-direction: column;
      }

      .player-frame-wrap {
        position: relative;
      }

      .player-loading {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-size: 9px;
        color: var(--fg-dim);
        background: radial-gradient(
          circle at top,
          rgba(0, 0, 0, 0.95),
          rgba(0, 0, 0, 0.98)
        );
        z-index: 2;
        text-align: center;
        padding: 16px;
      }

      .player-loading span {
        margin-top: 6px;
        opacity: 0.7;
      }

      /* right side = season/episode sidebar */
      .tv-side {
        width: 260px;
        max-width: 260px;
        border: 2px solid var(--border-hard, #262626);
        background: radial-gradient(circle at top left, #101010 0, #050505 60%);
        padding: 10px;
        font-size: 9px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .tv-side h2 {
        margin: 0;
        font-size: 11px;
        letter-spacing: 0.15em;
        text-transform: uppercase;
      }

      .tv-meta {
        font-size: 8px;
        color: var(--fg-dim, #7f7f7f);
      }

      .tv-season-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .tv-season-tab {
        font-size: 8px;
        padding: 3px 8px;
        border-radius: 0;
        border: 2px solid var(--border-hard, #262626);
        background: #000;
        color: var(--fg-dim, #aaaaaa);
        cursor: pointer;
        text-transform: uppercase;
      }

      .tv-season-tab.active {
        border-color: var(--accent, #00ff7f);
        color: var(--accent, #00ff7f);
        background: rgba(0, 255, 127, 0.12);
        box-shadow: 0 0 0 1px #000, 0 0 14px rgba(0, 255, 127, 0.5);
      }

      .tv-episode-header {
        font-size: 8px;
        color: var(--fg-dim, #7f7f7f);
        text-transform: uppercase;
        margin-top: 2px;
      }

      .tv-episode-list {
        flex: 1;
        margin-top: 4px;
        border: 1px solid var(--border-hard, #262626);
        background: #020617;
        padding: 4px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .tv-episode-item {
        font-size: 8px;
        padding: 4px 6px;
        text-align: left;
        background: #000;
        border: 1px solid #111827;
        color: var(--fg, #f5f5f5);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        gap: 6px;
      }

      .tv-episode-item span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .tv-episode-item.active {
        border-color: var(--accent, #00ff7f);
        color: var(--accent, #00ff7f);
        background: rgba(0, 255, 127, 0.15);
      }

      .tv-season-info {
        font-size: 8px;
        color: var(--fg-dim, #7f7f7f);
      }

      @media (max-width: 900px) {
        .tv-layout {
          flex-direction: column;
        }
        .tv-side {
          width: 100%;
          max-width: none;
          order: -1;
        }
        .tv-frame-wrap {
          min-height: 60vh;
        }
      }
    </style>
  </head>

  <body class="media-player-page">
    <header class="site-header">
      <div class="site-title">S0LACE</div>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="media.html" class="active">Media</a>
        <a href="apps.html">Apps</a>
        <a href="settings.html">Settings</a>
      </nav>
    </header>

    <main class="player-main tv-player-main">
      <div class="player-info">
        <div class="player-left">
          <span id="player-title">Loading…</span>
        </div>
        <div class="player-actions">
          <a href="media.html">← BACK TO MEDIA</a>
          <button id="open-new-tab">OPEN IN NEW TAB</button>
        </div>
      </div>

      <div class="tv-layout">
        <!-- LEFT: big player -->
        <div class="tv-frame-wrap">
          <div class="player-frame-wrap">
            <div id="player-loading" class="player-loading">
              CONNECTING TO PROXY…
              <span id="player-loading-sub">
                If this takes more than a few seconds, the media host or proxy might be slow.
              </span>
            </div>

            <iframe
              id="media-frame"
              src="about:blank"
              allowfullscreen
              allow="fullscreen; picture-in-picture; encrypted-media"
            ></iframe>
          </div>
        </div>

        <!-- RIGHT: season / episode sidebar -->
        <aside class="tv-side">
          <h2 id="tv-title-short">SEASONS</h2>
          <div id="tv-meta" class="tv-meta">Loading TMDB data…</div>

          <div id="season-tabs" class="tv-season-tabs"></div>

          <div class="tv-episode-header">EPISODES</div>
          <div id="episode-list" class="tv-episode-list"></div>

          <div id="season-info" class="tv-season-info"></div>
        </aside>
      </div>

      <div id="player-error" class="no-src" style="display:none;">
        No TV show info provided.
      </div>
    </main>

    <script>
      // ===== TMDB CONFIG =====
      const TMDB_KEY = "2d1351cf74f73892042699d0431b799a";

      const params = new URLSearchParams(window.location.search);
      const tvId = params.get("id");
      const tvTitle = params.get("title") || "Untitled";
      let currentSeason = parseInt(params.get("season") || "1", 10);
      let currentEpisode = parseInt(params.get("episode") || "1", 10);

      const frame = document.getElementById("media-frame");
      const titleEl = document.getElementById("player-title");
      const titleShortEl = document.getElementById("tv-title-short");
      const metaEl = document.getElementById("tv-meta");
      const seasonTabsEl = document.getElementById("season-tabs");
      const episodeListEl = document.getElementById("episode-list");
      const seasonInfoEl = document.getElementById("season-info");
      const errorEl = document.getElementById("player-error");
      const loadingEl = document.getElementById("player-loading");
      const loadingSub = document.getElementById("player-loading-sub");
      const openNewTabBtn = document.getElementById("open-new-tab");

      let seasonsMeta = []; // from /tv/{id}
      const episodesCache = new Map(); // season_number -> episodes[]
      let longTimeout = null;
      let hardTimeout = null;

      if (titleEl) titleEl.textContent = tvTitle;
      if (titleShortEl) titleShortEl.textContent = tvTitle;

      // ===== CINEMAOS URL BUILDER FOR TV =====
      function buildCinemaOsTvSrc(id, season, episode) {
        return (
          "/scram/https://cinemaos.tech/player/" +
          encodeURIComponent(id) +
          "/" +
          encodeURIComponent(season) +
          "/" +
          encodeURIComponent(episode)
        );
      }

      // ===== BAREMUX TRANSPORT =====
      async function setupBareMux() {
        try {
          const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
          const wispUrl =
            (location.protocol === "https:" ? "wss" : "ws") +
            "://" +
            location.host +
            "/wisp/";

          if ((await connection.getTransport()) !== "/epoxy/index.mjs") {
            await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
          }
          console.log("BareMux transport ready in tvplayer tab");
        } catch (err) {
          console.error("Failed to init BareMux transport (tvplayer)", err);
          if (loadingSub) {
            loadingSub.textContent =
              "Proxy transport failed to init. The page may still load, but some hosts will break.";
          }
        }
      }

      // ===== LOADING TIMEOUTS =====
      function startLoadingTimeouts() {
        if (longTimeout) clearTimeout(longTimeout);
        if (hardTimeout) clearTimeout(hardTimeout);

        longTimeout = setTimeout(() => {
          if (loadingSub) {
            loadingSub.textContent =
              "This is taking longer than usual. The media host or proxy might be slow or timing out.";
          }
        }, 8000);

        hardTimeout = setTimeout(() => {
          if (loadingEl) loadingEl.style.display = "none";
          if (errorEl) {
            errorEl.style.display = "flex";
            errorEl.textContent =
              "The media did not finish loading. It may be blocked, down, or the proxy hit a timeout.";
          }
        }, 25000);
      }

      function clearLoadingTimeouts() {
        if (longTimeout) clearTimeout(longTimeout);
        if (hardTimeout) clearTimeout(hardTimeout);
        longTimeout = null;
        hardTimeout = null;
      }

      // ===== LOAD IFRAME =====
      function loadFrameFor(season, episode) {
        if (!tvId) return;
        currentSeason = season;
        currentEpisode = episode;

        const src = buildCinemaOsTvSrc(tvId, season, episode);

        if (openNewTabBtn) {
          openNewTabBtn.onclick = () => {
            window.open(src, "_blank");
          };
        }

        if (loadingEl) loadingEl.style.display = "flex";
        if (errorEl) errorEl.style.display = "none";
        startLoadingTimeouts();

        if (frame) {
          frame.addEventListener(
            "load",
            () => {
              if (loadingEl) loadingEl.style.display = "none";
              clearLoadingTimeouts();
            },
            { once: true }
          );
          frame.src = src;
        }
      }

      // ===== TMDB: SHOW DETAILS =====
      async function loadTvDetails() {
        if (!tvId) {
          if (errorEl) {
            errorEl.style.display = "flex";
            errorEl.textContent = "No TV show ID provided.";
          }
          return;
        }

        try {
          const res = await fetch(
            `https://api.themoviedb.org/3/tv/${encodeURIComponent(
              tvId
            )}?api_key=${TMDB_KEY}&language=en-US`
          );
          if (!res.ok) throw new Error("TMDB HTTP " + res.status);
          const data = await res.json();

          seasonsMeta = (data.seasons || [])
            .filter((s) => s.season_number >= 1 && s.episode_count > 0)
            .sort((a, b) => a.season_number - b.season_number);

          if (!seasonsMeta.length) {
            if (metaEl) metaEl.textContent = "No seasons with episodes found.";
            return;
          }

          if (metaEl) {
            const firstAir = data.first_air_date || "";
            const numSeasons = seasonsMeta.length;
            metaEl.textContent =
              `${numSeasons} season${numSeasons !== 1 ? "s" : ""}` +
              (firstAir ? ` • First aired: ${firstAir}` : "");
          }

          // clamp season
          const minSeason = seasonsMeta[0].season_number;
          const maxSeason = seasonsMeta[seasonsMeta.length - 1].season_number;
          if (currentSeason < minSeason || currentSeason > maxSeason) {
            currentSeason = minSeason;
          }

          renderSeasonTabs();
          await loadSeasonUI(currentSeason, false); // initial, don't auto-change episode
        } catch (err) {
          console.error(err);
          if (metaEl) {
            metaEl.textContent =
              "Failed to load show info from TMDB: " + err.message;
          }
        }
      }

      // ===== TMDB: EPISODES FOR ONE SEASON =====
      async function getEpisodesForSeason(seasonNumber) {
        if (episodesCache.has(seasonNumber)) {
          return episodesCache.get(seasonNumber);
        }
        const res = await fetch(
          `https://api.themoviedb.org/3/tv/${encodeURIComponent(
            tvId
          )}/season/${seasonNumber}?api_key=${TMDB_KEY}&language=en-US`
        );
        if (!res.ok) throw new Error("TMDB HTTP " + res.status);
        const data = await res.json();
        const episodes = data.episodes || [];
        episodesCache.set(seasonNumber, episodes);
        return episodes;
      }

      // ===== UI: SEASON TABS =====
      function renderSeasonTabs() {
        if (!seasonTabsEl || !seasonsMeta.length) return;
        seasonTabsEl.innerHTML = "";

        seasonsMeta.forEach((s) => {
          const btn = document.createElement("button");
          btn.className =
            "tv-season-tab" +
            (s.season_number === currentSeason ? " active" : "");
          btn.textContent = "S" + s.season_number;
          btn.onclick = () => loadSeasonUI(s.season_number, true);
          seasonTabsEl.appendChild(btn);
        });
      }

      function updateSeasonTabsActive() {
        if (!seasonTabsEl) return;
        seasonTabsEl.querySelectorAll(".tv-season-tab").forEach((btn) => {
          const sNum = parseInt(btn.textContent.replace("S", ""), 10);
          btn.classList.toggle("active", sNum === currentSeason);
        });
      }

      // ===== UI: EPISODE LIST =====
      function renderEpisodeList(episodes) {
        if (!episodeListEl) return;
        episodeListEl.innerHTML = "";

        const total = episodes.length || 0;

        episodes.forEach((ep) => {
          const epNum = ep.episode_number;
          const name = ep.name || `Episode ${epNum}`;
          const item = document.createElement("button");
          item.className =
            "tv-episode-item" + (epNum === currentEpisode ? " active" : "");
          const left = document.createElement("span");
          left.textContent = `E${epNum}`;
          const right = document.createElement("span");
          right.textContent = name;
          item.appendChild(left);
          item.appendChild(right);

          item.onclick = () => {
            currentEpisode = epNum;
            renderEpisodeList(episodes);
            updateSeasonInfo(total);
            loadFrameFor(currentSeason, currentEpisode);
          };

          episodeListEl.appendChild(item);
        });

        updateSeasonInfo(total);
      }

      function updateSeasonInfo(totalEpisodes) {
        if (!seasonInfoEl) return;
        seasonInfoEl.textContent = `Season ${currentSeason} • ${totalEpisodes} episode${
          totalEpisodes !== 1 ? "s" : ""
        } • Now playing S${currentSeason}E${currentEpisode}`;
      }

      // ===== LOAD UI FOR ONE SEASON =====
      async function loadSeasonUI(seasonNumber, resetEpisode) {
        currentSeason = seasonNumber;
        updateSeasonTabsActive();

        try {
          const episodes = await getEpisodesForSeason(seasonNumber);
          if (!episodes.length) {
            renderEpisodeList([]);
            return;
          }

          if (resetEpisode) {
            currentEpisode = 1;
          }
          // Clamp episode
          if (currentEpisode < 1 || currentEpisode > episodes.length) {
            currentEpisode = 1;
          }

          renderEpisodeList(episodes);
          loadFrameFor(currentSeason, currentEpisode);
        } catch (err) {
          console.error(err);
          if (seasonInfoEl) {
            seasonInfoEl.textContent =
              "Failed to load episodes for season " +
              seasonNumber +
              ": " +
              err.message;
          }
        }
      }

      // ===== INIT =====
      (async () => {
        if (!tvId) {
          if (errorEl) {
            errorEl.style.display = "flex";
            errorEl.textContent = "No TV show ID provided.";
          }
          return;
        }

        await setupBareMux();
        await loadTvDetails();
      })();
    </script>
  </body>
</html>
